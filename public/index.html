<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Playlist Kleaner 5000</title>
  <style>
    /* ... (keep all existing CSS styles) ... */

    /* --- Optional: Styles for Mockery --- */
    #mockery-button {
        background-color: #ff4081; /* A sassy pink */
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 20px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.2s ease;
        display: none; /* Hidden initially */
        margin-top: 20px;
    }
    #mockery-button:hover {
        background-color: #e0004b;
    }
    #mockery-output {
        margin-top: 15px;
        padding: 15px;
        border: 1px dashed #ff98b7; /* Lighter pink dash */
        background-color: #fff5f8; /* Very light pink background */
        border-radius: 5px;
        font-style: italic;
        color: #555;
        display: none; /* Hidden initially */
        white-space: pre-wrap; /* Preserve line breaks from AI */
    }
    #mockery-loader {
        display: none; /* Hidden initially */
        margin: 15px auto;
        /* Uses the global .loader styles */
    }
    /* --- END Styles --- */
  </style>
</head>
<body>

  <div id="main-content">
      </div>

  <div id="tracks-section">
      <h2 id="tracks-header">Tracks</h2>
      <div id="tracks-loader" class="loader" style="display: none;"></div>
      <div id="tracks">
          <p>Select a playlist on the left to view its tracks.</p>
      </div>
      <button id="mockery-button">Let Miss Shade Read This Playlist</button>
      <div id="mockery-loader" class="loader"></div>
      <div id="mockery-output"></div>
      </div>


  <script>
    // Function to parse hash parameters (keep existing)
    const getHashParams = /* ... */ () => {/* ... */};

    // Get references to DOM elements (add new ones)
    const loginSection = document.getElementById('login-section');
    const userContent = document.getElementById('user-content');
    const errorMessageDiv = document.getElementById('error-message');
    const loader = document.getElementById('loader');
    const profileDiv = document.getElementById("profile");
    const playlistsDiv = document.getElementById("playlists");
    // const playlistCountSpan = document.getElementById("playlist-count"); // Not used?

    const tracksSection = document.getElementById("tracks-section");
    const tracksHeader = document.getElementById("tracks-header");
    const tracksLoader = document.getElementById("tracks-loader");
    const tracksDiv = document.getElementById("tracks");

    // --- New elements for Mockery ---
    const mockeryButton = document.getElementById("mockery-button");
    const mockeryLoader = document.getElementById("mockery-loader");
    const mockeryOutput = document.getElementById("mockery-output");
    // --- End new elements ---

    // Store access token globally
    let currentAccessToken = null;
    // --- NEW: Store current playlist tracks ---
    let currentPlaylistTracks = []; // To hold track data for mocking
    // --- END NEW ---

    // Get params from URL hash
    const params = getHashParams();
    currentAccessToken = params.access_token;
    const error = params.error;
    const errorDetails = params.details;

    // Function to display errors (keep existing)
    function displayError(message, details = '') { /* ... */ }

    // --- NEW: Function to call backend for mockery ---
    async function generateMockery() {
        console.log("Generate Mockery button clicked.");
        mockeryLoader.style.display = 'block';
        mockeryOutput.style.display = 'none'; // Hide previous output
        mockeryButton.disabled = true; // Prevent multiple clicks
        mockeryButton.textContent = "Thinking..."; // Update button text

        try {
            // 1. Get Playlist Name (extract from header or pass as argument)
            const playlistNameMatch = tracksHeader.textContent.match(/"([^"]+)"/);
            const playlistName = playlistNameMatch ? playlistNameMatch[1] : "this playlist";

            // 2. Get Track Data (Use the stored 'currentPlaylistTracks')
            // Limit the number of tracks to avoid overly long prompts
            const tracksForPrompt = currentPlaylistTracks.slice(0, 20); // Use first 20 tracks
            const trackListString = tracksForPrompt.map(t => `- "${t.name}" by ${t.artists}`).join('\n');

            if (tracksForPrompt.length === 0) {
                 mockeryOutput.textContent = "Honey, this playlist is empty. Even I can't read nothing!";
                 mockeryOutput.style.display = 'block';
                 mockeryLoader.style.display = 'none';
                 mockeryButton.disabled = false;
                 mockeryButton.textContent = "Let Miss Shade Read This Playlist";
                 return;
            }

            // 3. Construct the Prompt
            const prompt = `
You are 'Miss Shade', a hilarious, sassy, and slightly judgmental drag queen reviewing a user's Spotify playlist. Your tone is witty, observant, and uses drag slang (like 'honey', 'child', 'tea', 'reading', 'werk', 'gag', 'choices'). Be funny but not genuinely cruel.

You are looking at a playlist called "${playlistName}". Here are some of the tracks in it:
${trackListString}
${currentPlaylistTracks.length > 20 ? `\n(And ${currentPlaylistTracks.length - 20} more tracks...)` : ''}

Based *only* on this playlist name and list of tracks, give a short (2-3 sentences), funny, shady commentary or 'read' about the user's taste or the vibe of this specific playlist.
            `;

            console.log("Sending prompt to /api/generate-mockery"); // Don't log the full prompt

            // 4. Make the API call to YOUR backend
            const response = await fetch('/api/generate-mockery', { // Use relative path
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // No Authorization header needed here - backend handles Gemini key
                },
                body: JSON.stringify({ prompt: prompt }),
            });

            if (!response.ok) {
                let errorJson = {}; try { errorJson = await response.json(); } catch(e) {}
                throw new Error(errorJson.error || `API Error: ${response.status}`);
            }

            const data = await response.json();

            // 5. Display the result
            mockeryOutput.textContent = data.mockery;
            mockeryOutput.style.display = 'block';

        } catch (err) {
            console.error("Error generating mockery:", err);
            mockeryOutput.textContent = `Oh dear, my sequins seem to be stuck. Error: ${err.message}`;
            mockeryOutput.style.display = 'block';
        } finally {
            // 6. Reset UI elements
            mockeryLoader.style.display = 'none';
            mockeryButton.disabled = false;
            mockeryButton.textContent = "Let Miss Shade Read This Playlist";
        }
    }
    // --- END NEW FUNCTION ---


    // --- Function to fetch and display tracks (MODIFIED) ---
    async function fetchPlaylistTracks(playlistId, playlistName) {
        // ... (keep existing checks for token and playlistId) ...

        console.log(`Workspaceing tracks for playlist ID: ${playlistId}`);
        tracksSection.style.display = 'block';
        tracksHeader.textContent = `Tracks in "${playlistName}"`;
        tracksDiv.innerHTML = '';
        tracksLoader.style.display = 'block';
        errorMessageDiv.style.display = 'none';
        // --- NEW: Hide mockery elements initially ---
        mockeryButton.style.display = 'none';
        mockeryOutput.style.display = 'none';
        mockeryLoader.style.display = 'none';
        currentPlaylistTracks = []; // Reset tracks for new playlist
        // --- END NEW ---

        try {
            // NOTE: Using relative URL assuming frontend/backend are served from same origin
            // If on different origins (e.g., localhost:8080 and localhost:3000),
            // you might need the full URL: `http://localhost:3000/playlist-tracks/${playlistId}`
            const response = await fetch(`/playlist-tracks/${playlistId}`, {
                headers: { 'Authorization': `Bearer ${currentAccessToken}` }
            });
            // ... (keep existing error handling for fetch) ...

            const trackData = await response.json();
            console.log("Track data received:", trackData);
            tracksLoader.style.display = 'none';

            if (trackData.items && trackData.items.length > 0) {
                trackData.items.forEach(item => {
                    if (item.track) {
                        const track = item.track;
                        const artists = track.artists.map(a => a.name).join(', ');
                        // --- Store track info for mockery ---
                        currentPlaylistTracks.push({ name: track.name, artists: artists });
                        // --- END Store ---

                        const trackDiv = document.createElement("div");
                        trackDiv.className = "track-item";
                        trackDiv.innerHTML = `
                            <span class="track-name">${track.name}</span>
                            <span class="track-artists">${artists}</span>
                            `;
                        trackDiv.dataset.trackId = track.id;
                        trackDiv.dataset.trackUri = track.uri;
                        tracksDiv.appendChild(trackDiv);
                    }
                });
                // --- NEW: Show mockery button after tracks load ---
                 mockeryButton.style.display = 'block';
                 mockeryButton.disabled = false; // Ensure it's enabled
                 mockeryButton.textContent = "Let Miss Shade Read This Playlist";
                // --- END NEW ---
            } else {
                tracksDiv.innerHTML = "<p>This playlist appears to be empty.</p>";
                // Keep mockery button hidden if playlist is empty
                mockeryButton.style.display = 'none';
            }

        } catch (err) {
            console.error("Failed during fetchPlaylistTracks:", err);
            tracksLoader.style.display = 'none';
            tracksDiv.innerHTML = `<p style="color: red;">Could not load tracks: ${err.message}</p>`;
             // Keep mockery button hidden on error
             mockeryButton.style.display = 'none';
        }
    }


    // --- Main Logic Execution (MODIFIED) ---
    console.log("Page loaded. Checking for tokens or errors in URL hash...");
    console.log("Hash Params:", params);

    // ... (keep existing error/token checking logic) ...

    if (currentAccessToken) {
        // ... (keep logic for hiding login, showing loader, clearing hash) ...

        // --- Fetch initial user data (profile and playlists) (Keep as is) ---
        async function fetchUserData(token) { /* ... */ }
        fetchUserData(currentAccessToken);

        // --- Add Event Listener for Playlist Clicks (Keep as is) ---
        playlistsDiv.addEventListener('click', (event) => { /* ... */ });

        // --- NEW: Add Event Listener for Mockery Button ---
        mockeryButton.addEventListener('click', generateMockery);
        // --- END NEW ---

    } else {
         // ... (keep existing logic for initial state - hiding user content/tracks) ...
    }
  </script>
</body>
</html>